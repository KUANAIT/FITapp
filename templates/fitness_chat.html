<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fitness AI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --main-bg: #f8ffae;
            --main-bg-gradient: linear-gradient(135deg, #f8ffae 0%, #43cea2 100%);
            --card-bg: #fff;
            --header-gradient: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
            --text: #222;
        }
        body.light-theme {
            --main-bg: #f8ffae;
            --main-bg-gradient: linear-gradient(135deg, #f8ffae 0%, #43cea2 100%);
            --card-bg: #fff;
            --header-gradient: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
            --text: #222;
        }
        body.dark-theme {
            --main-bg: #232829;
            --main-bg-gradient: linear-gradient(135deg, #232829 0%, #485563 100%);
            --card-bg: #262b40;
            --header-gradient: linear-gradient(90deg, #232829 0%, #202342 100%);
            --text: #f3f3f3;
        }
        html, body {
            background: var(--main-bg-gradient) !important;
            color: var(--text) !important;
        }
        .chat-card, .card, .modal-content {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }
        .card-header {
            background: var(--header-gradient) !important;
        }
        .chat-card {
            max-width: 600px;
            margin: 40px auto;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.18);
        }
        .chat-area {
            height: 350px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 16px;
            background: #fafafa;
            margin-bottom: 16px;
        }
        .message { margin-bottom: 12px; }
        .user { color: #1976d2; font-weight: bold; }
        .ai { color: #388e3c; font-weight: bold; }
    </style>
</head>
<body>
<main class="container py-5 d-flex flex-column align-items-center justify-content-center min-vh-100">
    <button id="theme-toggle" class="btn btn-outline-secondary mb-3 mt-2 float-end" type="button" title="Toggle theme">
        <i id="theme-toggle-icon" class="bi bi-moon"></i>
    </button>
    <div class="card chat-card w-100">
        <div class="card-header bg-success text-white text-center">
            <h2 class="mb-0"><i class="bi bi-chat-dots"></i> Fitness AI Chat</h2>
        </div>
        <div class="card-body">
            <div id="chat-area" class="chat-area mb-3"></div>
            <form id="chat-form" class="d-flex gap-2" autocomplete="off">
                <input type="text" id="user-input" class="form-control" placeholder="Ask a fitness question..." required />
                <button type="submit" class="btn btn-success"><i class="bi bi-send"></i></button>
            </form>
            <a href="/" class="btn btn-outline-secondary mt-3"><i class="bi bi-arrow-left"></i> Back to Home</a>
            <script>
                const USER_NAME = "{{.UserName}}";
            </script>
        </div>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function() {
    const toggle = document.getElementById('theme-toggle');
    const icon = document.getElementById('theme-toggle-icon');
    function setTheme(theme) {
        document.body.classList.remove('light-theme', 'dark-theme');
        document.body.classList.add(theme+'-theme');
        localStorage.setItem('theme', theme);
        icon.className = (theme === 'dark' ? 'bi bi-sun' : 'bi bi-moon');
    }
    // Init
    const saved = localStorage.getItem('theme');
    if (saved) setTheme(saved);
    else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(prefersDark ? 'dark' : 'light');
    }
    toggle.addEventListener('click', function() {
        const now = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
        setTheme(now);
    });
})();
</script>
<script>
const chatArea = document.getElementById('chat-area');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');

function appendMessage(sender, text, isTyping = false) {
    const div = document.createElement('div');
    div.className = 'message d-flex align-items-start';
    let iconHtml = sender === 'ai'
        ? '<span class="me-2"><i class="bi bi-robot" style="font-size:1.3em;color:#388e3c;"></i></span>'
        : '<span class="me-2"><i class="bi bi-person-circle" style="font-size:1.3em;color:#1976d2;"></i></span>';
    if (sender === 'ai' && isTyping) {
        div.innerHTML = iconHtml + '<span class="ai">AI:</span> <span class="typing"></span>';
    } else if (sender === 'ai') {
        div.innerHTML = iconHtml + '<span class="ai">AI:</span> ' + marked.parse(text);
    } else {
        div.innerHTML = iconHtml + `<span class="user">${USER_NAME}:</span> ${text}`;
    }
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
    return div;
}

async function typeMessage(div, text, delay = 60) {
    const typingSpan = div.querySelector('.typing');
    if (!typingSpan) return;
    const words = text.split(/(\s+)/);
    typingSpan.innerHTML = '';
    for (let i = 0; i < words.length; i++) {
        typingSpan.innerHTML += words[i];
        chatArea.scrollTop = chatArea.scrollHeight;
        await new Promise(res => setTimeout(res, delay));
    }
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = userInput.value.trim();
    if (!question) return;
    appendMessage('user', question);
    userInput.value = '';
    const aiDiv = appendMessage('ai', '', true);
    try {
        const res = await fetch('/ask-fitness', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        });
        const data = await res.json();
        await typeMessage(aiDiv, data.answer, 20);
        aiDiv.innerHTML = '<span class="me-2"><i class="bi bi-robot" style="font-size:1.3em;color:#388e3c;"></i></span>' +
            '<span class="ai">AI:</span> ' + marked.parse(data.answer);
        chatArea.scrollTop = chatArea.scrollHeight;
    } catch (err) {
        aiDiv.innerHTML = '<span class="me-2"><i class="bi bi-robot" style="font-size:1.3em;color:#388e3c;"></i></span>' +
            '<span class="ai">AI:</span> Sorry, there was an error.';
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
